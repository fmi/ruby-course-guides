# Уеб приложения със Sinatra

Това ръководство има за цел да ви даде някои насоки ако сте избрали уеб сайт за проект. Повечето от нещата тук са препоръки и със сигурност има повече от един правилен начин да се направят.

## Sinatra crash course

Sinatra е DSL, който ви предоставя минимален набор от инструменти за създаване на уеб приложения. За разлика от Rails и други подобни на него, Sinatra не ви дава готова структура, заповядвайки ви коя част от кода ви къде да стои. Бихте могли да сложите всичко в един файл (което, разбира се, не трябва да правите).

Най-добрият източник на информация за Sinatra е [документацията](http://www.sinatrarb.com/intro.html).

## Rack

Sinatra, както и повечето фреймуъркове в света на Ruby, използва [Rack](http://rack.github.io/). Това е много полезно, защото Rack може да бъде разширяван чрез добавяне на посредници (middleware). Силно вероятно е ако ви липсва някаква функционалност, да намерите Rack посредник точно за това. Затова използвайте и `rack <feature>` в Google, вместо само `sinatra <feature>`. Например `Rack::Session::Cookie` добавя възможност за използване на сесия чрез бисквитки.

## База от данни

Щом ще правите уеб приложение е почти сигурно, че ще ви се наложи да използвате някаква база от данни. Конкретната база от данни, която ще изберете, за нас не е от значение.

### SQLite

SQLite е проста за използване SQL база от данни. Не се слави с голяма производителност, но е идеална докато разработвате проекта си, защото се "подкарва" лесно. Единственото, което ви е необходимо, е да добавите `gem 'sqlite3'` в `Gemfile`-а. _Забележка: Ако използвате windows може да се наложи да инсталирате допълнителни неща. [Този пост в github може да помогне.](https://github.com/sparklemotion/sqlite3-ruby/issues/82#issuecomment-18595074)_

Една база от данни при SQLite е просто `sqlite` файл.

### ORM и ActiveRecord

ORM (Object-Relational Mapping) библиотеките като ActiveRecord, Sequel, DataMapper и други ви предоставят удобен интерфейс за работа с SQL бази от данни. Ключовите неща са, че (почти) не ви се налага да пишете SQL заявки и можете лесно да превключвате между различни бази от данни (SQLite, PostgreSQL, MySQL и т.н.).

За интегриране на ActiveRecord и Sinatra, може да използвате [Sinatra-ActiveRecord](https://github.com/janko-m/sinatra-activerecord). Добро ръководство за ActiveRecord има [тук](http://guides.rubyonrails.org/active_record_basics.html).

#### Миграции

Почти всеки ORM ви предоставя възможност да създавате и изпълнявате миграции. Една миграция представлява инструкция за промяна на структурата на база от данни. Например добавяне на таблица, добавяне или премахване на поле от таблица и т.н.

Ръководство за създаване на ActiveRecord миграции има [тук](http://guides.rubyonrails.org/active_record_migrations.html). Единствената разлика при Sinatra-ActiveRecord е, че вместо `bin/rails generate migration <име>`, трябва да използвате `rake db:create_migration NAME=<име>`.

## Файлова структура

Както вече споменахме, Sinatra не ви дава готова файлова структура с инструкции къде какъв код да пишете. Затова е и много лесно да се вземе не чак толкова добър подход.

Хубаво е да си разделите проекта на следните директории:

- `routes` - Вътре слагате ruby файлове, които използват DSL-a на синатра. Всеки файл в тази директория отговаря за няколко адреса, свързани логически по някакъв начин. Например в `users.rb` може да се съдържат адресите за регистрация, вход, промяна на потребител и други свързани с потребители. Ето примерен такъв файл, който съдържа един адрес (`users/all`), на който се показва списък от всички потребители на сайта.

        get '/users/all' do
          @users = User.all
          erb :'users/all' # Това е пътят към темплейта в папката `views`. Обърнете внимание на това, че е символ.
        end

- `models` - Тук е мястото на моделите. Моделите са класове, чиято задача е да си комуникират с базата и да моделират някаква таблица от нея. Обикновено се създава по един клас за всяка такава. Ако използвате ORM почти няма да ви се налага да добавяте методи към тези класове. Ако не използвате ORM ще трябва да си създадете методи за нещата, които ще използвате. В горния пример сме използвали класов метод `all` на модела `User`. Примерна реализация за този модел може да е следният код:

        class Users
          def self.all
            # Забележка - db е връзката към базата от данни
            db.execute('select * from users').to_a
          end
        end

  Примерът не използва ORM - в ActiveRecord вече имате дефиниран такъв метод, който можете да използвате наготово.

- `views` - Това е мястото за HTML кода. Можете да използвате различни темплейт енджини като ERB, HAML и т.н. Разликата е (почти) единствено в начина по който се вгражда Ruby код в HTML. ERB е част от стандартната библиотека и е доста прост, затова ако се чудите кое да изберете - използвайте него. Всеки файл в тази директория съдържа HTML/ERB код за една страница. Например един `erb` файл (`views/users/all.erb`) за страницата `users/all` може да съдържа следното:

        <h1>Всички потребители</h1>
        <% @users.each do |user| %>
          <%= user.name %>
        <% end %>

  Хубаво е файловете да бъдат групирани по това за кои адреси и модели се отнасят - за всеки файл в `routes` тук ще има по една директория, с `erb` файлове за всеки адрес.

  Ако сложите файл с име `layout.erb`, той автоматично ще опакова всички останали темплейти.

        <html>
          <head></head>
          <body>
            <!-- На мястото на този yield ще се появава съдържанието на темплейта,
                 който е зададен за показване. Например `views/users/all.erb`
                 преди да бъде показан ще бъде визуализиран в този html. -->
            <%= yield %>
          </body>
        </html>

- `public` - Тук е мястото на всичко, което не е Ruby код - CSS, картинки, шрифтове, javascript код и подобни неща, разбира се добре разделени в подпапки. От тази папка (и нейните наследници), Sinatra директно изпраща файловете на браузъра. Например ако в има файл `public/img/картинка.png`, то на адреса `http://<сайт>/img/картинка.png` ще се показва тази картинка.

_Забележка: Всички файлове от `routes` и `models` трябва да бъдат require-нати във файла, в който се зарежда Sinatra (`app.rb`, `server.rb`, `app.ru` в зависимост от това кой туториал за Sinatra следвате)._

### Обобщение (MVC)

Файловете, които има в `routes` обикновено се наричат контролери - тяхната задача е да използват моделите и чрез вютата да показват неща на екрана.

Задачата на моделите (класовете в `models`) е да си комуникират с базата от данни, така че другите компоненти от системата да не знаят конкретно с каква база от данни се работи и да няма SQL код навсякъде.

Вютата пък просто генерират html от подадените им данни.

Този подход за структуриране на код се нарича MVC (Model-View-Controller).

Ако ви трябва по-специална логика, която не пасва на някое от трите места, може да създадете папка lib, в която да се намират класове, които са необходими за работата на проекта. Тези класове може да се използват в контролерите или моделите.
